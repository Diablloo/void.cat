<link rel="import" href="/bower_components/polymer/polymer-element.html">
<dom-module id="void-drop-zone">
    <template>
        <style>
            .drop-zone {
                height: 400px;
                border: 2px dashed #aaa;
                line-height: 400px;
                text-align: center;
                font-size: 50px;
            }

                .drop-zone:hover {
                    cursor: pointer;
                }
				
			.note {
				font-size: 12px;
				text-align: center;
			}
			
            .uploads {
                margin-top: 10px;
            }
			
			.stats {
				background-color: #0071a7;
				color: #eee;
				margin-left: auto;
				margin-right: auto;
				line-height: 25px;
				border-bottom-left-radius: 5px;
				border-bottom-right-radius: 5px;
				border-left: 1px solid #777;
				border-bottom: 1px solid #777;
				border-right: 1px solid #777;
				text-align: center;
				overflow: hidden;
			}
			
			.stats div {
				width: 25%;
				float: left;
			}

			.stats b {
				overflow: hidden;
			}
			
            @media(max-width: 1024px) {
                .drop-zone {
                    font-size: 30px;
                    height: 200px;
                    line-height: 200px;
                }
            }
			
			@media(max-width: 520px) {
				.stats b {
					display: block;
				}
			}
        </style>
        <div class="drop-zone">
            Max size [[formatBytes(maxSize, 0)]]
        </div>
		<div class="stats">
			<div><b>Files:</b> [[stats.files]]</div>
			<div><b>Total Size:</b> [[formatBytes(stats.size, 1)]]</div>
			<div><b>Avg Size:</b> [[formatBytes(stats.avgSize, 1)]]</div>
			<div><b>Transfer:</b> [[formatBytes(stats.transfer, 1)]]</div>
		</div>
		<template is="dom-if" if="[[expire]]">
			<br/><i class="note">**Expires after [[expire]] days since last view</i>
		</template>
        <div class="uploads">

        </div>
    </template>
</dom-module>

<script>
    class VoidDropZone extends Polymer.Element {
        static get is() { return "void-drop-zone"; }

        constructor() {
            super();

            this.formatBytes = Util.formatBytes;
        }

        ready() {
            super.ready();

            this.uploads = this.root.querySelector('.uploads');
			
			API.getServerConfig(function(cfg){
				this.self.maxSize = cfg.maxsize;
				this.self.expire = cfg.expire;
				this.self.stats = cfg.stats;
			}.bind({ self: this }));
            
            this.dz = this.root.querySelector('.drop-zone');
            this.dz.addEventListener('dragover', this.handleDragOver.bind({ self: this }), false);
            this.dz.addEventListener('drop', this.handleFileDropped.bind({ self: this }), false);
            this.dz.addEventListener('click', this.handleFileSelect.bind({ self: this }), false);
            document.addEventListener('paste', this.handleFilePaste.bind({ self: this }), false);
        }

        addFileUpload(file) {
            var nf = new VoidUpload(this, file);
            this.uploads.appendChild(nf);

            if (this.dz.style.height.length === 0) {
                this.dz.style.height = this.dz.style.lineHeight = this.dz.offsetHeight / 2 + 'px';
            }
        }

        handleFileSelect(evt) {
            var i = document.createElement('input');
            i.setAttribute('type', 'file');
            i.addEventListener('change', function (evt) {
                var fl = evt.target.files;
                for (let i = 0; i < fl.length; i++) {
                    let file = fl[i];
                    this.self.addFileUpload(file);
                }
            }.bind({ self: this.self }));
            i.click();
        }

        handleDragOver(evt) {
            evt.stopPropagation();
            evt.preventDefault();
            evt.dataTransfer.dropEffect = 'copy';
        }

        handleFileDropped(evt) {
            evt.stopPropagation();
            evt.preventDefault();

            let files = evt.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
                this.self.addFileUpload(files[i]);
            }
        }

        handleFilePaste(evt) {
            for (var i = 0; i < evt.clipboardData.items.length; i++) {
                var file = evt.clipboardData.items[i];
                if (file.kind === 'file') {
                    this.self.addFileUpload(file.getAsFile());
                } else if (file.kind === 'string' && file.type === 'text/plain') {
                    var file_t = file.getAsString(function (url) {
                        if (url.indexOf('http://') === 0 || url.indexOf('https://') === 0) {
                            this.self.addFileUpload(file);
                        }
                    }.bind({ self: this.self }));
                }
            }
        }
    }
    customElements.define(VoidDropZone.is, VoidDropZone)
</script>